
## Loading and preparing the data

The first step is to load and prepare the trade data. This data set was extracted from the Convention on International Trade in Endangered Species of Wild Fauna and Flora (CITES), an international treaty organization tasked with monitoring, reporting, and providing recommendations on the international species trade. 

This data set contains records on every international import or export conducted with species from the CITES lists in 2016. It contains columns identifying the species, the import and export countries, and the amount and characteristics of the goods being traded (which range from live animals to skins and cadavers).

```{r   }
library(data.table)     # Run once per session
library(ggplot2)        # Run once per session
library(dplyr)          # Run once per session
library(igraph)         # Run once per session
library(DT)             # Run once per session
library(shiny)          # Run once per session
library(ggmap)
library(leaflet)
library(bslib)

# Load data from file comptab_2018-01-29 16_00_comma_separated.csv 
dt.trade <- fread("cleaned_trade_data.csv") 
dt.trade.partial <- fread("partial_trade_data.csv") 

# Save dt.movie.actor. Next time you can simply call the load function (below)
save(dt.trade, file="trade.RData") 
save(dt.trade.partial, file="partial.trade.RData")

# Load previously saved dt.trade You can start in this line if you have previously saved these data.
load("trade.RData") 
load("partial.trade.RData")
```

Exploratory Data Analaysis and Data Cleaning 

```{r}
#how many rows does our data set contain 
nrow(dt.trade)

#what are the different columns in our data set
colnames(dt.trade)

#countrylist
l.countries <- as.list(unique(dt.trade$reporter_name))

```

Network

```{r}
# Set the parameters
dt.trade.country <- dt.trade[reporter_name == "Afghanistan"]
dt.trade.country.year <- dt.trade.country[year == 2018]

# Set the vertices
all.importers <- dt.trade.country.year[, list(name=unique(reporter_name), type=TRUE)]
all.exporters <- dt.trade.country.year[, list(name=unique(partner_name), type=FALSE)]

all.vertices <- rbind(all.importers, all.exporters)

# Create & plot the graph
g1 <- graph.data.frame(dt.trade.country.year[, list(reporter_name, partner_name)],
      directed=TRUE, vertices=all.vertices)

plot(g1, vertex.size = 5, vertex.label = NA)


#g2 <- graph.data.frame(dt.trade[, list(reporter_name, partner_name)], directed=FALSE)
#summary(g) 
#plot(g)
```


```{r}
#CREATING MAP TEST

library(shiny)
library(leaflet)

# Define UI --------------------------------------------------------------------

ui <- fluidPage(
  
  sidebarLayout(
    
    # Inputs: Select variables to plot
    sidebarPanel(
      
      # Select Trade
      selectInput(inputId = "trader", 
                  label = "Select Imports or Exports:",
                  choices = c("Exports"="reporter_name","Imports"="partner_name"), 
                  selected = "reporter_name"),
      
      # Select country
      selectInput(inputId = "country", 
                  label = "Select Country:",
                  choices = l.countries, 
                  selected = "Portugal"),
      
      # Select variable for color
      selectInput(inputId = "color_var", 
                  label = "Select variable for color:",
                  choices = c("Trade Value (USD)"="trade_value_usd","Trade Value (1000 USD)"="trade_value_1000_usd"), 
                  selected = "trade_value_usd"),
      
      # Set year range
      selectInput(inputId = "year",
                  label = "Year:",
                  choices = c(levels(as.factor(dt.trade$year))),
                  selected = "2017",
                  multiple = FALSE)
    ),
    
    
    # Output: Show map
    mainPanel(
      leafletOutput(outputId = "map", width = "100%", height = "600px")
    )
  )
)


# Define server ----------------------------------------------------------------

server <- function(input, output, session) {
  
  output$map <- renderLeaflet({
    
    # Filter data
    if(input$trader=="Exports"){
      dt.trade.country <- dt.trade[ dt.trade$reporter_name == input$country, ]
      dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ]
      dt.trade.country.year$type <- "exporter"
    } else {
      dt.trade.country <- dt.trade[ dt.trade$partner_name == input$country, ]
      dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ] 
      dt.trade.country.year$type <- "importer"
    }       
    
    # Aggregate trade values by country
    trade_values <- aggregate(dt.trade.country.year[,input$color_var], 
                              by=list(dt.trade.country.year[,ifelse(input$trader=="Exports","partner_name","reporter_name")]), 
                              sum)
    
    # Merge trade values with geospatial data
    locations <- merge(dt.locations, trade_values, by.x = "name", by.y = "Group.1", all.x = TRUE)
    
    # Create map
    map <- leaflet() %>% 
      addProviderTiles("Stamen.TonerLite") %>% 
      setView(lng = 0, lat = 30, zoom = 2) %>% 
      addCircleMarkers(data = locations, 
                       radius = sqrt(locations[,2])/1000, 
                       color = ifelse(locations$type=="exporter","green","red"),
                       opacity = 0.8, 
                       fillOpacity = 0.8, 
                       popup = paste("<b>", locations$name, "</b><br>",
                                     "Trade Value:", round(locations[,2]/1e6, 2), "million USD")
      )
    
    map
  })
  
}

# Create a Shiny app object ----------------------------------------------------

shinyApp(ui = ui, server = server)



```







```{r}

# Define UI --------------------------------------------------------------------

ui <- fluidPage(
  
      # App title ----
  titlePanel("Shiny App for International Trade"),
  
  navbarPage(title = "Network Analytics",
           tabPanel(title = "Rankings"),
           tabPanel(title = "Descriptive"),
           tabPanel(title = "Interactive Map"),
           theme = bs_theme(bg = "white",
                            fg = "black",
                            primary = "maroon",
                            base_font = font_google("Montserrat")
                            )
          ),
  
  
  sidebarLayout(
    
    # Inputs: Select variables to plot
    sidebarPanel(
      
      img(src = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/World_Trade_Organization_%28logo_and_wordmark%29.svg/2560px-World_Trade_Organization_%28logo_and_wordmark%29.svg.png",width="100%"),
      
      # Select Trade
      selectInput(inputId = "trader", 
                  label = "Select Imports or Exports:",
                  choices = c("Exports"="reporter_name","Imports"="partner_name"), 
                  selected = "reporter_name"),
      
      # Select country
      selectInput(inputId = "country", 
                  label = "Select Country:",
                  choices = l.countries, 
                  selected = "Portugal"),
      
      
      # Select variable for color
      #selectInput(inputId = "___", 
      #            label = "____",
      #            choices = c(),
      #            selected = "___"),
      
      # Set year range
      selectInput(inputId = "year",
                  label = "Year:",
                  choices = c(levels(as.factor(dt.trade$year))),
                  selected = "2017",
                  multiple = FALSE)
    ),
    
    
    # Output: Show network
    mainPanel(

      plotOutput(outputId = "plot")
    )
  )
)


# Define server ----------------------------------------------------------------

server <- function(input, output, session) {
  
  output$plot <- renderPlot({
    
    # Set the parameters
    if(input$trader=="Exports"){
      dt.trade.country <- dt.trade[ dt.trade$reporter_name == input$country, ]
      dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ]
      } else {
        dt.trade.country <- dt.trade[ dt.trade$partner_name == input$country, ]
        dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ] 
        }       

    # Set the vertices
    all.importers <- dt.trade.country.year[, list(name=unique(reporter_name), type=TRUE)]
    all.exporters <- dt.trade.country.year[, list(name=unique(partner_name), type=FALSE)]

    all.vertices <- rbind(all.importers, all.exporters)

    # Create & plot the graph
    g1 <- graph.data.frame(dt.trade.country.year[, list(reporter_name, partner_name)],
                           directed=TRUE, vertices=all.vertices)

    plot(g1, vertex.size = 5, vertex.label = NA)
  })
  

}



# Create a Shiny app object ----------------------------------------------------

shinyApp(ui = ui, server = server)

```




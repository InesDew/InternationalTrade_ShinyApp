
## Loading and preparing the data

The first step is to load and prepare the trade data. This data set was extracted from the Convention on International Trade in Endangered Species of Wild Fauna and Flora (CITES), an international treaty organization tasked with monitoring, reporting, and providing recommendations on the international species trade. 

This data set contains records on every international import or export conducted with species from the CITES lists in 2016. It contains columns identifying the species, the import and export countries, and the amount and characteristics of the goods being traded (which range from live animals to skins and cadavers).

```{r   }
library(data.table)     # Run once per session
library(ggplot2)        # Run once per session
library(dplyr)          # Run once per session
library(igraph)         # Run once per session
library(DT)             # Run once per session
library(shiny)          # Run once per session
library(ggmap)
library(leaflet)
library(bslib)

# Load data from file comptab_2018-01-29 16_00_comma_separated.csv 
dt.trade <- fread("cleaned_trade_data.csv") 

# Save dt.movie.actor. Next time you can simply call the load function (below)
save(dt.trade, file="trade.RData") 

# Load previously saved dt.trade You can start in this line if you have previously saved these data.
load("trade.RData") 
```

Exploratory Data Analaysis and Data Cleaning 

```{r}
#how many rows does our data set contain 
nrow(dt.trade)

#what are the different columns in our data set
colnames(dt.trade)

#countrylist
l.countries <- as.list(unique(dt.trade$reporter_name))

```

Network

```{r}
# Set the parameters
dt.trade.country <- dt.trade[reporter_name == "Afghanistan"]
dt.trade.country.year <- dt.trade.country[year == 2018]

# Set the vertices
all.importers <- dt.trade.country.year[, list(name=unique(reporter_name), type=TRUE)]
all.exporters <- dt.trade.country.year[, list(name=unique(partner_name), type=FALSE)]

all.vertices <- rbind(all.importers, all.exporters)

# Create & plot the graph
g1 <- graph.data.frame(dt.trade.country.year[, list(reporter_name, partner_name)],
      directed=TRUE, vertices=all.vertices)

plot(g1, vertex.size = 5, vertex.label = NA)


#g2 <- graph.data.frame(dt.trade[, list(reporter_name, partner_name)], directed=FALSE)
#summary(g) 
#plot(g)
```


```{r}
#CREATING MAP TEST


# Define UI --------------------------------------------------------------------

ui <- fluidPage(

      # App title ----
  titlePanel("Shiny App for International Trade"),
  
  navbarPage(title = "Network Analytics",
           tabPanel(title = "Rankings"),
           tabPanel(title = "Descriptive"),
           tabPanel(title = "Interactive Map")
          ),
  
  
  sidebarLayout(
    
    # Inputs: Select variables to plot
    sidebarPanel(
      
      img(src = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/World_Trade_Organization_%28logo_and_wordmark%29.svg/2560px-World_Trade_Organization_%28logo_and_wordmark%29.svg.png",width="100%"),
      
      # Select Trade
      selectInput(inputId = "trader", 
                  label = "Select Imports or Exports:",
                  choices = c("Exports"="reporter_name","Imports"="partner_name"), 
                  selected = "reporter_name"),
      
      # Select country
      selectInput(inputId = "country", 
                  label = "Select Country:",
                  choices = l.countries, 
                  selected = "Portugal"),
      
      
      # Set year range
      selectInput(inputId = "year",
                  label = "Year:",
                  choices = c(levels(as.factor(dt.trade$year))),
                  selected = "2017",
                  multiple = FALSE)
    ),
    
    
    # Output: Show network
    mainPanel(
      img(src = "my_image.png", height = 72, width = 72),
      leafletOutput(outputId = "map")
    )
  )
)


# Define server ----------------------------------------------------------------

server <- function(input, output, session) {
  
output$map <- renderLeaflet({
  
  # Set the parameters
  if(input$trader=="Exports"){
    dt.trade.country <- dt.trade[ dt.trade$reporter_name == input$country, ]
    dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ]
  } else {
    dt.trade.country <- dt.trade[ dt.trade$partner_name == input$country, ]
    dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ] 
  }       

  # Set the vertices
  all.importers <- dt.trade.country.year[, list(name=unique(reporter_name), type=TRUE, lat=unique(reporter_lat), lon=unique(reporter_long))]
  all.exporters <- dt.trade.country.year[, list(name=unique(partner_name), type=FALSE, lat=unique(partner_lat), lon=unique(partner_long))]

  all.vertices <- rbind(all.importers, all.exporters)
  
  # Create & plot the graph
  g1 <- graph.data.frame(dt.trade.country.year[, list(reporter_name, partner_name)],
                         directed=TRUE, vertices=all.vertices)
  
  # Create the map
  mymap <- leaflet() %>%
    addTiles() %>%
    setView(lng=mean(all.vertices$lon), lat=mean(all.vertices$lat), zoom=2)

  # Add the edges
  mymap <- mymap %>% addPolylines(data=data.frame(dt.trade.country.year[, c("reporter_long", "reporter_lat", "partner_long", "partner_lat")]), lng1=~reporter_long, lat1=~reporter_lat, lng2=~partner_long, lat2=~partner_lat, color="red")

  # Add the vertices
  mymap <- mymap %>% addCircleMarkers(data=all.vertices, lat=~lat, lng=~lon, label=~name, group=~type, color="black", radius=5)

  # Add the legend
  mymap <- mymap %>% addLegend(position="bottomright", colors="black", labels=c("Partner", "Reporter"))

  # Return the map
  mymap
  
})
  

}


# Create a Shiny app object ----------------------------------------------------

shinyApp(ui = ui, server = server)



```







```{r}

# Define UI --------------------------------------------------------------------

ui <- fluidPage(
  
      # App title ----
  titlePanel("Shiny App for International Trade"),
  
  navbarPage(title = "Network Analytics",
           tabPanel(title = "Rankings"),
           tabPanel(title = "Descriptive"),
           tabPanel(title = "Interactive Map"),
           theme = bs_theme(bg = "white",
                            fg = "black",
                            primary = "maroon",
                            base_font = font_google("Montserrat")
                            )
          ),
  
  
  sidebarLayout(
    
    # Inputs: Select variables to plot
    sidebarPanel(
      
      img(src = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/World_Trade_Organization_%28logo_and_wordmark%29.svg/2560px-World_Trade_Organization_%28logo_and_wordmark%29.svg.png",width="100%"),
      
      # Select Trade
      selectInput(inputId = "trader", 
                  label = "Select Imports or Exports:",
                  choices = c("Exports"="reporter_name","Imports"="partner_name"), 
                  selected = "reporter_name"),
      
      # Select country
      selectInput(inputId = "country", 
                  label = "Select Country:",
                  choices = l.countries, 
                  selected = "Portugal"),
      
      
      # Select variable for color
      #selectInput(inputId = "___", 
      #            label = "____",
      #            choices = c(),
      #            selected = "___"),
      
      # Set year range
      selectInput(inputId = "year",
                  label = "Year:",
                  choices = c(levels(as.factor(dt.trade$year))),
                  selected = "2017",
                  multiple = FALSE)
    ),
    
    
    # Output: Show network
    mainPanel(

      plotOutput(outputId = "plot")
    )
  )
)


# Define server ----------------------------------------------------------------

server <- function(input, output, session) {
  
  output$plot <- renderPlot({
    
    # Set the parameters
    if(input$trader=="Exports"){
      dt.trade.country <- dt.trade[ dt.trade$reporter_name == input$country, ]
      dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ]
      } else {
        dt.trade.country <- dt.trade[ dt.trade$partner_name == input$country, ]
        dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ] 
        }       

    # Set the vertices
    all.importers <- dt.trade.country.year[, list(name=unique(reporter_name), type=TRUE)]
    all.exporters <- dt.trade.country.year[, list(name=unique(partner_name), type=FALSE)]

    all.vertices <- rbind(all.importers, all.exporters)

    # Create & plot the graph
    g1 <- graph.data.frame(dt.trade.country.year[, list(reporter_name, partner_name)],
                           directed=TRUE, vertices=all.vertices)

    plot(g1, vertex.size = 5, vertex.label = NA)
  })
  

}



# Create a Shiny app object ----------------------------------------------------

shinyApp(ui = ui, server = server)

```




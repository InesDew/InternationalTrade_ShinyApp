```{r}
library(shiny)
library(data.table)
library(ggplot2)
library(igraph) 
library(DT)
library(rjson)
library(bslib)

# Load data
dt.trade <- fread("../../data/cleaned_trade_data.csv")

# Define UI
ui <- fluidPage(
  # App title
  titlePanel("Shiny App for International Trade"),
  
  navbarPage(
    title = "Network Analytics",
    tabPanel("Descriptives",
             sidebarLayout(
               sidebarPanel(
                 img(src = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/World_Trade_Organization_%28logo_and_wordmark%29.svg/2560px-World_Trade_Organization_%28logo_and_wordmark%29.svg.png", width = "100%"),
                 selectInput(
                   inputId = "desc_yearInput",
                   label = "Year:",
                   choices = c("", levels(as.factor(dt.trade$year))),
                   selected = "",
                   multiple = FALSE
                 ),
                 actionButton("submit_desc", "Submit")
               ),
               mainPanel(
                 plotOutput("network")
               )
             )
    ),
    tabPanel("Data",
             sidebarLayout(
               sidebarPanel(
                 selectInput(
                   inputId = "filter_reporter",
                   label = "Reporter:",
                   choices = c("", levels(as.factor(dt.trade$reporter_name))),
                   selected = "",
                   multiple = FALSE
                 ),
                 selectInput(
                   inputId = "filter_partner",
                   label = "Partner:",
                   choices = c("", levels(as.factor(dt.trade$partner_name))),
                   selected = "",
                   multiple = FALSE
                 ),
                 selectInput(
                   inputId = "filter_year",
                   label = "Year:",
                   choices = c("", levels(as.factor(dt.trade$year))),
                   selected = "",
                   multiple = FALSE
                 ),
                 actionButton("submit_filter", "Submit")
               ),
               mainPanel(
                 DTOutput("data_table")
               )
             )
    ),
    theme = bs_theme(bg = "white", fg = "black", primary = "maroon", base_font = font_google("Montserrat"))
  )
)

# Define server
server <- function(input, output, session) {
  
  # Data table output
  output$data_table <- renderDT({
    # Filter data
    filtered_data <- dt.trade
    if (input$filter_reporter != "") {
      filtered_data <- filtered_data[reporter_name %in% input$filter_reporter]
    }
    if (input$filter_partner != "") {
      filtered_data <- filtered_data[partner_name %in% input$filter_partner]
    }
    if (input$filter_year != "") {
      filtered_data <- filtered_data[year == input$filter_year]
    }
    datatable(
      filtered_data[, c("reporter_name", "partner_name", "trade_value_usd", "reporter_continent", "partner_continent", "year")],
      filter = "top"
    )
  })
  
  output$network <- renderPlot({
    # 1. Make edge list
    dt.trade.year <- dt.trade[year == input$desc_yearInput]
    dt.trade.edgelist <- dt.trade.year[, c('reporter_name', 'partner_name')]
    
    # 2. Convert edge list to an igraph network
    # igraph wants our data in matrix format
    m.trade <- as.matrix(dt.trade.edgelist) 
    g.trade <- graph_from_edgelist(m.trade, directed = TRUE)
    
    # 3. Set the weight of the edges (trade_value_usd)
    edge.attributes(g.trade)$weight <- dt.trade.year$trade_value_usd
    # Sum the weights for duplicate edges (we would need this if we select           # multiple years) TODO
    
    # 4. Add attributes to the vertices (continent)
    json_data <- fromJSON(file='../../data/sample.json')
    V(g.trade)$continent <-  unlist(json_data[V(g.trade)$name])
    
    # 5. Plot igraph
    plot(g.trade, vertex.size = 5, vertex.label.cex = 0.3, edge.arrow.size=0.4)
  })
}

# Create a Shiny app object
shinyApp(ui = ui, server = server)

```


## Loading and preparing the data

The first step is to load and prepare the trade data. This data set was extracted from the Convention on International Trade in Endangered Species of Wild Fauna and Flora (CITES), an international treaty organization tasked with monitoring, reporting, and providing recommendations on the international species trade. 

This data set contains records on every international import or export conducted with species from the CITES lists in 2016. It contains columns identifying the species, the import and export countries, and the amount and characteristics of the goods being traded (which range from live animals to skins and cadavers).

```{r   }
library(data.table)     # Run once per session
library(ggplot2)        # Run once per session
library(dplyr)          # Run once per session
library(igraph)         # Run once per session
library(DT)             # Run once per session
library(shiny)          # Run once per session
library(ggmap)
library(leaflet)
library(bslib)
library(sf)

# Load data from file comptab_2018-01-29 16_00_comma_separated.csv 
dt.trade <- fread("../../data/cleaned_trade_data.csv") 


# Save dt.movie.actor. Next time you can simply call the load function (below)
save(dt.trade, file="trade.RData") 


# Load previously saved dt.trade You can start in this line if you have previously saved these data.
load("trade.RData") 

```

Exploratory Data Analaysis and Data Cleaning 

```{r}
#how many rows does our data set contain 
nrow(dt.trade)

#what are the different columns in our data set
colnames(dt.trade)

#countrylist
l.countries <- as.list(unique(dt.trade$reporter_name))


dt.trade <- dt.trade[complete.cases(dt.trade), ]


dt.country.coordinates <- dt.trade %>% distinct(partner_name, .keep_all = TRUE)
dt.country.coordinates <- dt.country.coordinates[, c("partner_name", "partner_lat", "partner_long")]
meta <- dt.country.coordinates %>% rename("name" = "partner_name", "lat" = "partner_lat", "lon" = "partner_long")
```

Network

```{r}
# Set the parameters
dt.trade.country <- dt.trade[reporter_name == "Afghanistan"]
dt.trade.country.year <- dt.trade.country[year == 2018]

# Set the vertices
all.importers <- dt.trade.country.year[, list(name=unique(reporter_name), type=TRUE)]
all.exporters <- dt.trade.country.year[, list(name=unique(partner_name), type=FALSE)]

all.vertices <- rbind(all.importers, all.exporters)

# Create & plot the graph
g1 <- graph.data.frame(dt.trade.country.year[, list(reporter_name, partner_name)],
      directed=TRUE, vertices=all.vertices)

plot(g1, vertex.size = 5, vertex.label = NA)

E(g1)
V(g1)

#g2 <- graph.data.frame(dt.trade[, list(reporter_name, partner_name)], directed=FALSE)

```
```{r}
library(igraph)
library(leaflet)

# Subset the data to the country and year of interest
dt.trade.country <- dt.trade[reporter_name == "Afghanistan"]
dt.trade.country.year <- dt.trade.country[year == 2018]

# Set the vertices
all.importers <- dt.trade.country.year[, list(name=unique(reporter_name), type=TRUE)]
all.exporters <- dt.trade.country.year[, list(name=unique(partner_name), type=FALSE)]

all.vertices <- rbind(all.importers, all.exporters)


# Create the graph
g1 <- graph.data.frame(dt.trade.country.year[, list(reporter_name, partner_name)],
                       directed=TRUE)

# Get the vertex data frame
vertices_df <- as_data_frame(g1)

# Update the long and lat values based on the type attribute
vertices_df$long <- ifelse(vertices_df$type, vertices_df$reporter_long, vertices_df$partner_long)
vertices_df$lat <- ifelse(vertices_df$type, vertices_df$reporter_lat, vertices_df$partner_lat)

# Select only the name, long, and lat columns
vertices_df <- vertices_df[, c("name", "long", "lat")]

# Create a leaflet map
map <- leaflet(vertices_df) %>% addTiles() %>%
  addPolylines(data=edges_df, lng1 = ~long.x, lat1 = ~lat.x, lng2 = ~long.y, lat2 = ~lat.y)

# Show the map
map






```

```{r}

#MAP 3 ATTEMPT

library(sp)
library(igraph)
library(leaflet)

# Subset the data to the country and year of interest
dt.trade.country <- dt.trade[reporter_name == "Hungary"]
dt.trade.country.year <- dt.trade.country[year == 2018]

df<-data.frame("from" = dt.trade.country.year$reporter_name, 
               "to"= dt.trade.country.year$partner_name)


g <- graph.data.frame(df, directed=FALSE, vertices=meta)


gg <- get.data.frame(g, "both")
vert <- gg$vertices
coordinates(vert) <- ~lon + lat

edges <- gg$edges

edges <- lapply(1:nrow(edges), function(i) {
  as(rbind(vert[vert$name == edges[i, "from"], ], 
           vert[vert$name == edges[i, "to"], ]), 
     "SpatialLines")
})


for (i in seq_along(edges)) {
  edges[[i]] <- spChFIDs(edges[[i]], as.character(i))
}

edges <- do.call(rbind, edges)


library(leaflet)
leaflet(vert) %>% addTiles() %>% addCircleMarkers(data = vert,radius = 2, 
    color = "red", 
    fillColor = "red", 
    fillOpacity = 0.8,
    stroke = FALSE) %>% addPolylines(data = edges, weight = 1, color = "blue")
```

```{r}
#ONLY MAP, NO SHINY APP 
library(tidyverse)
library(leaflet)
library(leaflet.extras)

dt.trade.country <- dt.trade[reporter_name == "Portugal"]
dt.trade.country.year <- dt.trade.country[year == 2018]


# Create edges from dt.trade
edges <- dt.trade.country.year %>%
  select(reporter_name, partner_name) %>%
  distinct() %>%
  graph_from_data_frame(directed = FALSE)

# Create nodes with latitude and longitude coordinates
nodes <- dt.trade.country.year %>%
  select(name = reporter_name, lon = reporter_long, lat = reporter_lat) %>%
  distinct() %>%
  bind_rows(dt.trade %>%
              select(name = partner_name, lon = partner_long, lat = partner_lat) %>%
              distinct()) %>%
  distinct()

# Plot the network on a map
leaflet() %>%
  addTiles() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(data = nodes,
                   label = ~name,
                   radius = 10,
                   color = "red") %>%
  addPolylines(data = get.edgelist(edges),
               weight = 2,
               color = "blue")




```


```{r}
#SHINY APP WITH MAP 


# Define UI --------------------------------------------------------------------

ui <- fluidPage(
  
      # App title ----
  titlePanel("Shiny App for International Trade"),
  
  navbarPage(title = "Network Analytics",
           tabPanel(title = "Rankings"),
           tabPanel(title = "Descriptive"),
           tabPanel(title = "Interactive Map"),
           theme = bs_theme(bg = "white",
                            fg = "black",
                            primary = "maroon",
                            base_font = font_google("Montserrat")
                            )
          ),
  
  
  sidebarLayout(
    
    # Inputs: Select variables to plot
    sidebarPanel(
      
      img(src = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/World_Trade_Organization_%28logo_and_wordmark%29.svg/2560px-World_Trade_Organization_%28logo_and_wordmark%29.svg.png",width="100%"),
      
      # Select Trade
      selectInput(inputId = "trader", 
                  label = "Select Imports or Exports:",
                  choices = c("Exports"="reporter_name","Imports"="partner_name"), 
                  selected = "reporter_name"),
      
      # Select country
      selectInput(inputId = "country", 
                  label = "Select Country:",
                  choices = l.countries, 
                  selected = "Portugal"),
      
      
      # Select variable for color
      #selectInput(inputId = "___", 
      #            label = "____",
      #            choices = c(),
      #            selected = "___"),
      
      # Set year range
      selectInput(inputId = "year",
                  label = "Year:",
                  choices = c(levels(as.factor(dt.trade$year))),
                  selected = "2017",
                  multiple = FALSE)
    ),
    
    
    # Output: Show network
    mainPanel(

      plotOutput(outputId = "plot")
    )
  )
)


# Define server ----------------------------------------------------------------

server <- function(input, output, session) {
  


  output$plot <- renderPlot({

    # Set the parameters
    if(input$trader=="Exports"){
      dt.trade.country <- dt.trade[ dt.trade$reporter_name == input$country, ]
      dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ]
    } else {
      dt.trade.country <- dt.trade[ dt.trade$partner_name == input$country, ]
      dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ] 
    }       

    # Set the vertices
    all.importers <- dt.trade.country.year[, list(name=unique(reporter_name), type=TRUE)]
    all.exporters <- dt.trade.country.year[, list(name=unique(partner_name), type=FALSE)]

    all.vertices <- rbind(all.importers, all.exporters)

    # Create the graph
    edges <- dt.trade.country.year %>%
      select(reporter_name, partner_name) %>%
      distinct() %>%
      graph_from_data_frame(directed = FALSE)

    # Create nodes with latitude and longitude coordinates
    nodes <- all.vertices %>%
      distinct() %>%
      left_join(select(dt.trade, reporter_name, reporter_lat, reporter_long), by = c("name" = "reporter_name")) %>%
      left_join(select(dt.trade, partner_name, partner_lat, partner_long), by = c("name" = "partner_name")) %>%
      select(name, lat = ifelse(is.na(reporter_lat), partner_lat, reporter_lat), lon = ifelse(is.na(reporter_long), partner_long,
                                                                                              reporter_long), type)

    # Plot the graph on a map
    ggplot(nodes) +
      geom_sf(aes(fill = type), size = 0.1, color = "black", alpha = 0.5) +
      geom_sf_text(aes(label = name), size = 3, fontface = "bold", color = "black") +
      geom_sf_text(aes(label = ifelse(type, "Exporter", "Importer")), size = 2, color = "white") +
      scale_fill_manual(values = c("#ff7f0e", "#1f77b4")) +
      labs(title = paste(input$country, "Trade Network in", input$year),
           subtitle = paste("Showing", input$trader, "of", input$country),
           fill = "") +
      theme_void() +
      theme(plot.title = element_text(size = 20, margin = margin(b = 10)),
            plot.subtitle = element_text(size = 14, margin = margin(b = 30)),
            plot.margin = margin(5, 5, 5, 5))
  })
}



# Create a Shiny app object ----------------------------------------------------

shinyApp(ui = ui, server = server)

```








```{r}

#SHINY APP WORKING BUT WITHOUT MAP 


# Define UI --------------------------------------------------------------------

ui <- fluidPage(
  
      # App title ----
  titlePanel("Shiny App for International Trade"),
  
  navbarPage(title = "Network Analytics",
           tabPanel(title = "Rankings"),
           tabPanel(title = "Descriptive"),
           tabPanel(title = "Interactive Map"),
           theme = bs_theme(bg = "white",
                            fg = "black",
                            primary = "maroon",
                            base_font = font_google("Montserrat")
                            )
          ),
  
  
  sidebarLayout(
    
    # Inputs: Select variables to plot
    sidebarPanel(
      
      img(src = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/World_Trade_Organization_%28logo_and_wordmark%29.svg/2560px-World_Trade_Organization_%28logo_and_wordmark%29.svg.png",width="100%"),
      
      # Select Trade
      selectInput(inputId = "trader", 
                  label = "Select Imports or Exports:",
                  choices = c("Exports"="reporter_name","Imports"="partner_name"), 
                  selected = "reporter_name"),
      
      # Select country
      selectInput(inputId = "country", 
                  label = "Select Country:",
                  choices = l.countries, 
                  selected = "Portugal"),
      
      
      # Select variable for color
      #selectInput(inputId = "___", 
      #            label = "____",
      #            choices = c(),
      #            selected = "___"),
      
      # Set year range
      selectInput(inputId = "year",
                  label = "Year:",
                  choices = c(levels(as.factor(dt.trade$year))),
                  selected = "2017",
                  multiple = FALSE)
    ),
    
    
    # Output: Show network
    mainPanel(

      plotOutput(outputId = "plot")
    )
  )
)


# Define server ----------------------------------------------------------------

server <- function(input, output, session) {
  
  output$plot <- renderPlot({
    
    # Set the parameters
    if(input$trader=="Exports"){
      dt.trade.country <- dt.trade[ dt.trade$reporter_name == input$country, ]
      dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ]
      } else {
        dt.trade.country <- dt.trade[ dt.trade$partner_name == input$country, ]
        dt.trade.country.year <- dt.trade.country[dt.trade.country$year == input$year, ] 
        }       

    # Set the vertices
    all.importers <- dt.trade.country.year[, list(name=unique(reporter_name), type=TRUE)]
    all.exporters <- dt.trade.country.year[, list(name=unique(partner_name), type=FALSE)]

    all.vertices <- rbind(all.importers, all.exporters)

    # Create & plot the graph
    g1 <- graph.data.frame(dt.trade.country.year[, list(reporter_name, partner_name)],
                           directed=TRUE, vertices=all.vertices)

    plot(g1, vertex.size = 5, vertex.label = NA)
  })
  

}



# Create a Shiny app object ----------------------------------------------------

shinyApp(ui = ui, server = server)

```



